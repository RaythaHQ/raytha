<!--
category: Authentication
title: JWT Authentication
description: Configure JWT-based single sign-on authentication
sortOrder: 1
icon: bi-file-earmark-lock
-->

<h1>JWT Authentication</h1>
<p class="lead">Configure JWT (JSON Web Token) authentication to enable single sign-on from external applications.</p>

<h2>What is JWT Authentication?</h2>
<p>JWT authentication allows users to log in to Raytha using tokens generated by your external application or identity system. This enables:</p>
<ul>
  <li>Single sign-on (SSO) from your main application</li>
  <li>Seamless authentication across multiple services</li>
  <li>User provisioning from external systems</li>
</ul>

<h2>How It Works</h2>
<ol>
  <li>Your application authenticates the user</li>
  <li>Your application generates a signed JWT containing user information</li>
  <li>User is redirected to Raytha with the JWT</li>
  <li>Raytha validates the token and creates/updates the user session</li>
</ol>

<img src="https://placehold.co/800x350?text=JWT+Authentication+Flow" alt="JWT Authentication Flow" class="img-fluid my-3 border rounded">

<h2>Creating a JWT Authentication Scheme</h2>
<ol>
  <li>Go to <strong>Settings</strong> &gt; <strong>Authentication Schemes</strong></li>
  <li>Click <strong>Create Authentication Scheme</strong></li>
  <li>Select <strong>JWT</strong> as the type</li>
  <li>Configure the settings below</li>
  <li>Click <strong>Create</strong></li>
</ol>

<img src="../../images/jwt-configuration-form.png" alt="JWT Configuration Form" class="img-fluid my-3 border rounded">

<h2>Configuration Settings</h2>

<table class="table">
  <thead>
    <tr>
      <th>Setting</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Label</strong></td>
      <td>Display name on the login page</td>
    </tr>
    <tr>
      <td><strong>Developer Name</strong></td>
      <td>Unique identifier</td>
    </tr>
    <tr>
      <td><strong>Secret Key</strong></td>
      <td>Shared secret for HMAC signing (HS256)</td>
    </tr>
    <tr>
      <td><strong>Sign-In URL</strong></td>
      <td>URL to redirect users for authentication</td>
    </tr>
    <tr>
      <td><strong>Enabled for Admins</strong></td>
      <td>Allow admin panel login</td>
    </tr>
    <tr>
      <td><strong>Enabled for Users</strong></td>
      <td>Allow public user login</td>
    </tr>
    <tr>
      <td><strong>Login Button Text</strong></td>
      <td>Text displayed on login button</td>
    </tr>
    <tr>
      <td><strong>Use High Security</strong></td>
      <td>Enable additional validation (JTI tracking)</td>
    </tr>
  </tbody>
</table>

<h2>JWT Token Requirements</h2>
<p>Your JWT must include these claims:</p>

<h3>Required Claims</h3>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Claim</th>
      <th>Description</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>sub</code></td>
      <td>Unique user identifier (SSO ID)</td>
      <td><code>"user-12345"</code></td>
    </tr>
    <tr>
      <td><code>email</code></td>
      <td>User's email address</td>
      <td><code>"user@example.com"</code></td>
    </tr>
    <tr>
      <td><code>exp</code></td>
      <td>Expiration timestamp (Unix)</td>
      <td><code>1704067200</code></td>
    </tr>
    <tr>
      <td><code>iat</code></td>
      <td>Issued at timestamp (Unix)</td>
      <td><code>1704063600</code></td>
    </tr>
  </tbody>
</table>

<h3>Optional Claims</h3>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Claim</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>given_name</code></td>
      <td>User's first name</td>
    </tr>
    <tr>
      <td><code>family_name</code></td>
      <td>User's last name</td>
    </tr>
    <tr>
      <td><code>jti</code></td>
      <td>Unique token ID (required if High Security enabled)</td>
    </tr>
  </tbody>
</table>

<h2>Example JWT Payload</h2>
<pre><code>{
  "sub": "user-12345",
  "email": "john.doe@example.com",
  "given_name": "John",
  "family_name": "Doe",
  "iat": 1704063600,
  "exp": 1704067200,
  "jti": "unique-token-id-xyz"
}</code></pre>

<h2>Generating JWTs</h2>

<h3>Node.js Example</h3>
<pre><code>const jwt = require('jsonwebtoken');

const secretKey = 'your-shared-secret-key';

const token = jwt.sign(
  {
    sub: 'user-12345',
    email: 'john.doe@example.com',
    given_name: 'John',
    family_name: 'Doe',
    jti: crypto.randomUUID()
  },
  secretKey,
  {
    algorithm: 'HS256',
    expiresIn: '1h'
  }
);

// Redirect user to Raytha
const raythaLoginUrl = `https://yoursite.com/account/login/jwt/{developer_name}?token=${token}`;
res.redirect(raythaLoginUrl);</code></pre>

<h3>Python Example</h3>
<pre><code>import jwt
import uuid
from datetime import datetime, timedelta

secret_key = 'your-shared-secret-key'

payload = {
    'sub': 'user-12345',
    'email': 'john.doe@example.com',
    'given_name': 'John',
    'family_name': 'Doe',
    'iat': datetime.utcnow(),
    'exp': datetime.utcnow() + timedelta(hours=1),
    'jti': str(uuid.uuid4())
}

token = jwt.encode(payload, secret_key, algorithm='HS256')

# Redirect user to Raytha
raytha_login_url = f'https://yoursite.com/account/login/jwt/{developer_name}?token={token}'</code></pre>

<h3>C# Example</h3>
<pre><code>using System.IdentityModel.Tokens.Jwt;
using Microsoft.IdentityModel.Tokens;

var secretKey = "your-shared-secret-key";
var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey));
var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

var claims = new[]
{
    new Claim(JwtRegisteredClaimNames.Sub, "user-12345"),
    new Claim(JwtRegisteredClaimNames.Email, "john.doe@example.com"),
    new Claim(JwtRegisteredClaimNames.GivenName, "John"),
    new Claim(JwtRegisteredClaimNames.FamilyName, "Doe"),
    new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
};

var token = new JwtSecurityToken(
    claims: claims,
    expires: DateTime.UtcNow.AddHours(1),
    signingCredentials: credentials
);

var tokenString = new JwtSecurityTokenHandler().WriteToken(token);

// Redirect to Raytha
var raythaLoginUrl = $"https://yoursite.com/account/login/jwt/{developerName}?token={tokenString}";</code></pre>

<h2>Login URL Format</h2>
<pre><code>https://yoursite.com/account/login/jwt/{developer_name}?token={jwt_token}</code></pre>

<p>Replace <code>{developer_name}</code> with your authentication scheme's developer name.</p>

<h2>High Security Mode</h2>
<p>When enabled, Raytha tracks used JTI values to prevent token replay attacks:</p>
<ul>
  <li>Each token can only be used once</li>
  <li><code>jti</code> claim becomes required</li>
  <li>Used JTIs are stored and checked against new tokens</li>
</ul>

<h2>User Provisioning</h2>
<p>When a JWT login occurs:</p>
<ul>
  <li>If user exists (by SSO ID or email): Session is created</li>
  <li>If user doesn't exist: User is created with JWT claim data</li>
</ul>

<h2>Troubleshooting</h2>

<h3>Token validation failed</h3>
<ul>
  <li>Verify secret key matches exactly</li>
  <li>Check token hasn't expired</li>
  <li>Ensure algorithm is HS256</li>
</ul>

<h3>User not created</h3>
<ul>
  <li>Verify required claims are present</li>
  <li>Check email is valid format</li>
</ul>

<h3>JTI already used (High Security)</h3>
<ul>
  <li>Generate a new unique JTI for each login</li>
  <li>Don't reuse tokens</li>
</ul>

