@page "/raytha/site-pages/layout/{id}"
@model Raytha.Web.Areas.Admin.Pages.SitePages.Layout
@inject ICurrentOrganization CurrentOrganization

@{
    Layout = "SidebarLayout";
    ViewData["Title"] = $"Layout: {Model.SitePage.Title}";
    ViewData["ActiveMenu"] = "Site Pages";

    BackLinkOptions back = new BackLinkOptions
    {
        Page = RouteNames.SitePages.Index
    };
}

@section headstyles {
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-extra.min.css" rel="stylesheet" />
    <style>
        .gs-12>.grid-stack-item {
            width: 8.333%;
        }

        .gs-12>.grid-stack-item[gs-w="2"] {
            width: 16.667%;
        }

        .gs-12>.grid-stack-item[gs-w="3"] {
            width: 25%;
        }

        .gs-12>.grid-stack-item[gs-w="4"] {
            width: 33.333%;
        }

        .gs-12>.grid-stack-item[gs-w="5"] {
            width: 41.667%;
        }

        .gs-12>.grid-stack-item[gs-w="6"] {
            width: 50%;
        }

        .gs-12>.grid-stack-item[gs-w="7"] {
            width: 58.333%;
        }

        .gs-12>.grid-stack-item[gs-w="8"] {
            width: 66.667%;
        }

        .gs-12>.grid-stack-item[gs-w="9"] {
            width: 75%;
        }

        .gs-12>.grid-stack-item[gs-w="10"] {
            width: 83.333%;
        }

        .gs-12>.grid-stack-item[gs-w="11"] {
            width: 91.667%;
        }

        .gs-12>.grid-stack-item[gs-w="12"] {
            width: 100%;
        }

        .grid-stack {
            background: #f8f9fa;
            min-height: 400px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
        }

        .grid-stack-item-content {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .widget-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .widget-card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .widget-card-title {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .widget-card-actions {
            display: flex;
            gap: 4px;
        }

        .widget-card-actions .btn {
            padding: 2px 6px;
            font-size: 12px;
        }

        .widget-card-body {
            padding: 12px;
            flex: 1;
            overflow: hidden;
        }

        .widget-summary {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .widget-picker {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .widget-picker-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .widget-picker-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .grid-stack-placeholder>.placeholder-content {
            background: #e3f2fd !important;
            border: 2px dashed #2196f3 !important;
            border-radius: 6px;
        }

        .empty-grid-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6c757d;
            pointer-events: none;
        }

        .grid-stack-item.ui-draggable-dragging {
            z-index: 1000;
        }

        .orphaned-grid {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
            min-height: 150px;
        }

        .orphaned-grid .grid-stack-item-content {
            border-color: #ffc107;
            background: #fffbf0;
        }
    </style>
}

<div class="row mb-4">
    <partial name="_Partials/PageHeading" model='ViewData["Title"]' />
    <div class="col-lg-9 col-md-8">
        <div class="card border-0 shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    @(await Html.PartialAsync("_Partials/BackToList", back))
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-light text-dark" id="unsavedIndicator" style="display: none;">
                        <i class="bi bi-circle-fill text-warning me-1" style="font-size: 8px;"></i>
                        Saving draft...
                    </span>
                    <span class="badge bg-warning text-dark" id="draftIndicator"
                        style="display: @(Model.SitePage.IsDraft ? "inline-block" : "none");">
                        <i class="bi bi-pencil-square me-1"></i>
                        Saved as draft
                    </span>
                    @if (Model.SitePage.IsDraft)
                    {
                        <form method="post" asp-page-handler="DiscardDraft" asp-route-id="@Model.SitePage.Id"
                            class="d-inline" id="discardDraftForm">
                            <button type="submit" class="btn btn-outline-secondary btn-sm" id="discardDraftBtn">
                                <i class="bi bi-x-lg me-1"></i> Discard draft
                            </button>
                        </form>
                    }
                    <button type="button" class="btn btn-success btn-sm" id="publishBtn">
                        <i class="bi bi-check-lg me-1"></i> Save and publish
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">
                            @Model.SitePage.Title
                            @if (Model.SitePage.IsPublished)
                            {
                                <span class="badge bg-success ms-2">Published</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary ms-2">Unpublished</span>
                            }
                        </h5>
                        <small class="text-muted">URL: <code>/@Model.SitePage.RoutePath</code></small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <a asp-page="@RouteNames.SitePages.Edit" asp-route-id="@Model.SitePage.Id"
                            class="btn btn-outline-secondary">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </a>
                        <a href="@(CurrentOrganization.WebsiteUrl.TrimEnd('/') + CurrentOrganization.PathBase)/@Model.SitePage.RoutePath?previewDraft=true"
                            target="_blank" class="btn btn-outline-secondary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Preview
                        </a>
                    </div>
                </div>

                @foreach (var sectionName in Model.DetectedSections)
                {
                    <div class="mb-4">
                        <label class="form-label fw-semibold">
                            Section: <code>@sectionName</code>
                        </label>
                        <div class="position-relative">
                            <div class="grid-stack gs-12 widget-grid" id="widgetGrid-@sectionName"
                                data-section="@sectionName">
                                <!-- Widgets will be rendered here -->
                            </div>
                            <div class="empty-grid-message" id="emptyGridMessage-@sectionName">
                                <i class="bi bi-plus-circle fs-1 d-block mb-2"></i>
                                <p>Drag widgets from the panel to add them here</p>
                            </div>
                        </div>
                    </div>
                }

                @foreach (var sectionName in Model.OrphanedSections)
                {
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Section: <code>@sectionName</code>
                            <span class="badge bg-warning text-dark ms-2">Orphaned</span>
                        </label>
                        <div class="alert alert-warning mb-2" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Warning:</strong> This section no longer exists in the page template.
                            Widgets in this section will not be displayed on the public site.
                            Drag them to an active section above to preserve them.
                        </div>
                        <div class="position-relative">
                            <div class="grid-stack gs-12 widget-grid orphaned-grid" id="widgetGrid-@sectionName"
                                data-section="@sectionName" data-orphaned="true">
                                <!-- Orphaned widgets will be rendered here -->
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-4">
        <div class="card border-0 shadow mb-4 sticky-top" style="top: 20px;">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-puzzle me-2"></i>Add Widget</h6>
            </div>
            <div class="card-body p-0">
                <div class="widget-picker">
                    @foreach (var widgetType in Model.AvailableWidgetTypes)
                    {
                        <div class="widget-picker-item p-3 border-bottom" data-widget-type="@widgetType.DeveloperName"
                            data-widget-name="@widgetType.DisplayName" data-widget-icon="@widgetType.IconClass">
                            <div class="d-flex align-items-center">
                                <i class="bi @widgetType.IconClass fs-4 text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-0">@widgetType.DisplayName</h6>
                                    <small class="text-muted">@widgetType.Description</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="card border-0 shadow">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Tips</h6>
            </div>
            <div class="card-body small text-muted">
                <ul class="mb-0 ps-3">
                    <li>Click a widget type to add it to the grid</li>
                    <li>Drag widgets to reposition them</li>
                    <li>Resize widgets by dragging their edges</li>
                    <li>Click "Edit" to configure widget settings</li>
                    <li>Don't forget to save your changes!</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Widget Template (hidden) -->
<template id="widgetCardTemplate">
    <div class="widget-card">
        <div class="widget-card-header">
            <h6 class="widget-card-title">
                <i class="bi widget-icon"></i>
                <span class="widget-name"></span>
            </h6>
            <div class="widget-card-actions">
                <button type="button" class="btn btn-outline-primary btn-sm widget-edit-btn" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm widget-duplicate-btn" title="Duplicate">
                    <i class="bi bi-copy"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm widget-delete-btn" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="widget-card-body">
            <p class="widget-summary"></p>
        </div>
    </div>
</template>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-all.min.js"></script>
    <script>
        (function () {
            const pageId = '@Model.SitePage.Id';
            const initialWidgets = @Html.Raw(Model.WidgetsJson);
            const sectionNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetectedSections));
            const orphanedSectionNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OrphanedSections));
            const allSectionNames = [...sectionNames, ...orphanedSectionNames];
            let hasUnsavedChanges = false;
            let isDraft = @(Model.SitePage.IsDraft ? "true" : "false");
            const grids = {}; // Map of sectionName -> GridStack instance
            let activeSection = sectionNames[0] || 'main';
            let saveTimeout = null;
            let isInitialLoad = true; // Prevent auto-save during initial widget load

            // Initialize on DOM ready
            document.addEventListener('DOMContentLoaded', function () {
                initGrids();
                loadWidgets();
                isInitialLoad = false; // Allow auto-save after initial load completes
                setupEventListeners();
                updateDraftUI();
            });

            function initGrids() {
                // Initialize grids for all sections including orphaned ones
                allSectionNames.forEach(function (sectionName) {
                    const gridEl = document.getElementById('widgetGrid-' + sectionName);
                    if (!gridEl) return;

                    const grid = GridStack.init({
                        column: 12,
                        cellHeight: 100,
                        margin: 10,
                        float: false, // Widgets compact vertically, no empty rows
                        disableOneColumnMode: true,
                        removable: false,
                        acceptWidgets: true,
                        resizable: {
                            handles: 'e, w' // Only allow horizontal resizing
                        },
                    }, gridEl);

                    grid.on('change', function () {
                        if (isInitialLoad) return;
                        markUnsaved();
                        updateEmptyMessage(sectionName);
                        autoSaveDraft();
                    });

                    grid.on('added', function () {
                        updateEmptyMessage(sectionName);
                        if (isInitialLoad) return;
                        autoSaveDraft();
                    });

                    grid.on('removed', function () {
                        updateEmptyMessage(sectionName);
                        if (isInitialLoad) return;
                        autoSaveDraft();
                    });

                    grids[sectionName] = grid;
                });
            }

            function loadWidgets() {
                // Load widgets from all sections including orphaned ones
                allSectionNames.forEach(function (sectionName) {
                    const widgets = initialWidgets[sectionName] || [];
                    widgets.forEach(function (widget) {
                        addWidgetToGrid(widget, sectionName);
                    });
                    updateEmptyMessage(sectionName);
                });
            }

            function addWidgetToGrid(widgetData, sectionName) {
                const grid = grids[sectionName];
                if (!grid) return;

                const template = document.getElementById('widgetCardTemplate');
                const content = template.content.cloneNode(true);

                const card = content.querySelector('.widget-card');
                card.querySelector('.widget-icon').className = 'bi ' + (widgetData.iconClass || 'bi-puzzle');
                card.querySelector('.widget-name').textContent = widgetData.displayName || widgetData.widgetType;
                card.querySelector('.widget-summary').textContent = widgetData.adminSummary || 'Click Edit to configure';

                const wrapper = document.createElement('div');
                wrapper.appendChild(card);

                const gridItem = grid.addWidget({
                    x: widgetData.column || 0,
                    y: widgetData.row || 0,
                    w: widgetData.columnSpan || 12,
                    h: 1,
                    content: wrapper.innerHTML,
                    id: widgetData.id || generateId(),
                });

                // Store widget data on the element
                gridItem.dataset.widgetType = widgetData.widgetType;
                gridItem.dataset.widgetId = widgetData.id || generateId();
                gridItem.dataset.settingsJson = widgetData.settingsJson || '{}';
                gridItem.dataset.displayName = widgetData.displayName || widgetData.widgetType;
                gridItem.dataset.iconClass = widgetData.iconClass || 'bi-puzzle';
                gridItem.dataset.sectionName = sectionName;
                // Store meta fields
                gridItem.dataset.cssClass = widgetData.cssClass || '';
                gridItem.dataset.htmlId = widgetData.htmlId || '';
                gridItem.dataset.customAttributes = widgetData.customAttributes || '';

                // Setup widget action buttons
                setupWidgetActions(gridItem, sectionName);
            }

            function setupWidgetActions(gridItem, sectionName) {
                const editBtn = gridItem.querySelector('.widget-edit-btn');
                const duplicateBtn = gridItem.querySelector('.widget-duplicate-btn');
                const deleteBtn = gridItem.querySelector('.widget-delete-btn');

                if (editBtn) {
                    editBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        // Navigate to widget edit page - auto-save first if needed
                        const editUrl = `/raytha/site-pages/${pageId}/widget/edit?widgetId=${gridItem.dataset.widgetId}&widgetType=${gridItem.dataset.widgetType}&sectionName=${sectionName}`;
                        if (hasUnsavedChanges) {
                            // Auto-save as draft then navigate
                            saveAllLayoutsAsDraft().then(() => {
                                window.location.href = editUrl;
                            });
                        } else {
                            window.location.href = editUrl;
                        }
                    });
                }

                if (duplicateBtn) {
                    duplicateBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        duplicateWidget(gridItem, sectionName);
                    });
                }

                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this widget?')) {
                            grids[sectionName].removeWidget(gridItem);
                            markUnsaved();
                        }
                    });
                }
            }

            function duplicateWidget(gridItem, sectionName) {
                const newWidget = {
                    id: generateId(),
                    widgetType: gridItem.dataset.widgetType,
                    settingsJson: gridItem.dataset.settingsJson,
                    row: parseInt(gridItem.getAttribute('gs-y')) + 1,
                    column: parseInt(gridItem.getAttribute('gs-x')),
                    columnSpan: parseInt(gridItem.getAttribute('gs-w')),
                    displayName: gridItem.dataset.displayName,
                    iconClass: gridItem.dataset.iconClass,
                    adminSummary: gridItem.querySelector('.widget-summary')?.textContent || '',
                    cssClass: gridItem.dataset.cssClass || '',
                    htmlId: '', // Don't duplicate HTML ID to avoid duplicates
                    customAttributes: gridItem.dataset.customAttributes || '',
                };
                addWidgetToGrid(newWidget, sectionName);
                markUnsaved();
            }

            function setupEventListeners() {
                // Widget picker click - always add to first section
                // User can drag to other sections as needed
                document.querySelectorAll('.widget-picker-item').forEach(function (item) {
                    item.addEventListener('click', function () {
                        const widgetType = this.dataset.widgetType;
                        const widgetName = this.dataset.widgetName;
                        const widgetIcon = this.dataset.widgetIcon;

                        // Always add to first section
                        const targetSection = sectionNames[0];

                        addWidgetToGrid({
                            id: generateId(),
                            widgetType: widgetType,
                            settingsJson: '{}',
                            row: 0,
                            column: 0,
                            columnSpan: 12,
                            displayName: widgetName,
                            iconClass: widgetIcon,
                            adminSummary: 'Click Edit to configure',
                            cssClass: '',
                            htmlId: '',
                            customAttributes: '',
                        }, targetSection);
                        markUnsaved();
                    });
                });

                // Publish button
                document.getElementById('publishBtn').addEventListener('click', publishLayout);

                // Warn before leaving with unsaved changes
                window.addEventListener('beforeunload', function (e) {
                    if (hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }

            function autoSaveDraft() {
                // Debounce auto-save
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                saveTimeout = setTimeout(function () {
                    saveAllLayoutsAsDraft();
                }, 1000); // Auto-save after 1 second of inactivity
            }

            function markUnsaved() {
                hasUnsavedChanges = true;
                document.getElementById('unsavedIndicator').style.display = 'inline-block';
            }

            function markSaved() {
                hasUnsavedChanges = false;
                document.getElementById('unsavedIndicator').style.display = 'none';
            }

            function updateDraftUI() {
                const draftIndicator = document.getElementById('draftIndicator');
                const discardForm = document.getElementById('discardDraftForm');

                if (isDraft) {
                    if (draftIndicator) draftIndicator.style.display = 'inline-block';
                    if (discardForm) discardForm.style.display = 'inline';
                } else {
                    if (draftIndicator) draftIndicator.style.display = 'none';
                    if (discardForm) discardForm.style.display = 'none';
                }
            }

            function updateEmptyMessage(sectionName) {
                const grid = grids[sectionName];
                if (!grid) return;
                const items = grid.getGridItems();
                const emptyMsg = document.getElementById('emptyGridMessage-' + sectionName);
                if (emptyMsg) {
                    emptyMsg.style.display = items.length === 0 ? 'block' : 'none';
                }
            }

            async function saveAllLayoutsAsDraft() {
                try {
                    // Save all sections including orphaned ones
                    for (const sectionName of allSectionNames) {
                        await saveSectionLayout(sectionName);
                    }
                    markSaved();
                    isDraft = true;
                    updateDraftUI();
                    showToast('Saved as draft', 'success');
                } catch (error) {
                    showToast('Error saving: ' + error.message, 'error');
                }
            }

            async function publishLayout() {
                const publishBtn = document.getElementById('publishBtn');
                publishBtn.disabled = true;
                publishBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Publishing...';

                try {
                    // First save any pending changes as draft (including orphaned sections)
                    if (hasUnsavedChanges) {
                        for (const sectionName of allSectionNames) {
                            await saveSectionLayout(sectionName);
                        }
                    }

                    // Then publish
                    const response = await fetch(window.location.pathname + '?handler=Publish', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        markSaved();
                        isDraft = false;
                        updateDraftUI();
                        showToast('Layout published successfully!', 'success');
                        // Reload to refresh the page state
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        throw new Error(data.errors?.join(', ') || 'Unknown error');
                    }
                } catch (error) {
                    showToast('Error publishing: ' + error.message, 'error');
                }

                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save and publish';
            }

            function saveSectionLayout(sectionName) {
                const grid = grids[sectionName];
                if (!grid) return Promise.resolve();

                const items = grid.getGridItems();
                const widgets = items.map(function (item) {
                    return {
                        id: item.dataset.widgetId,
                        widgetType: item.dataset.widgetType,
                        settingsJson: item.dataset.settingsJson,
                        row: parseInt(item.getAttribute('gs-y')) || 0,
                        column: parseInt(item.getAttribute('gs-x')) || 0,
                        columnSpan: parseInt(item.getAttribute('gs-w')) || 12,
                        cssClass: item.dataset.cssClass || '',
                        htmlId: item.dataset.htmlId || '',
                        customAttributes: item.dataset.customAttributes || '',
                    };
                });

                return fetch(window.location.pathname + '?handler=SaveLayout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        sectionName: sectionName,
                        widgets: widgets
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.errors?.join(', ') || 'Unknown error');
                        }
                        return data;
                    });
            }

            function showToast(message, type) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = 'position-fixed bottom-0 end-0 p-3';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                                                                                <div class="toast show align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'}" role="alert">
                                                                                    <div class="d-flex">
                                                                                        <div class="toast-body">${message}</div>
                                                                                        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button>
                                                                                    </div>
                                                                                </div>
                                                                            `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            function generateId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        })();
    </script>
    @Html.AntiForgeryToken()
}
