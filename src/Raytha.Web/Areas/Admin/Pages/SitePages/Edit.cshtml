@page "/raytha/site-pages/edit/{id}"
@using Raytha.Domain.Entities
@inject IAuthorizationService AuthorizationService
@model Raytha.Web.Areas.Admin.Pages.SitePages.Edit

@{
    Layout = "SubActionLayout";
    ViewData["Title"] = $"Edit: {Model.Form.Title}";
    ViewData["ActiveMenu"] = "Site Pages";
    ViewData["ActiveSubMenu"] = "Edit";

    BackLinkOptions back = new BackLinkOptions
    {
        Page = RouteNames.SitePages.Index
    };
}

@(await Html.PartialAsync("_Partials/BackToList", back))

<div class="d-flex justify-content-between align-items-center mb-3 mt-3">
    <div>
        @if (Model.Form.IsPublished)
        {
            <span class="badge bg-success me-2">Published</span>
        }
        else
        {
            <span class="badge bg-secondary me-2">Unpublished</span>
        }
        @if (Model.Form.IsDraft)
        {
            <span class="badge bg-warning text-dark">Has Draft</span>
        }
        @if (Model.IsHomePage)
        {
            <span class="badge bg-primary">Home Page</span>
        }
    </div>
</div>

<div class="alert alert-light border mb-4">
    <div class="row small">
        <div class="col-md-6">
            <strong>Created:</strong> @Model.CreatedAt
        </div>
        <div class="col-md-6">
            <strong>Last Modified:</strong> @Model.LastModifiedAt
        </div>
        <div class="col-md-6">
            <strong>Modified By:</strong> @Model.LastModifiedBy
        </div>
    </div>
</div>

<form asp-page="@RouteNames.SitePages.Edit" asp-route-id="@Model.Form.Id" method="post" class="py-2" novalidate>
    <input type="hidden" asp-for="Form.Id" />
    <input type="hidden" asp-for="Form.IsPublished" />
    <input type="hidden" asp-for="Form.IsDraft" />
    
    <div class="col-lg-12">
        <div class="mb-3">
            <label class="form-label raytha-required" asp-for="Form.Title"></label>
            <input type="text" class="form-control @Model.HasError("Title")" asp-for="Form.Title"
                required>
            <div class="invalid-feedback">@Model.ErrorMessageFor("Title")</div>
        </div>
    </div>
    <div class="col-lg-12">
        <div class="mb-3">
            <label class="form-label raytha-required" asp-for="Form.RoutePath"></label>
            <div class="input-group">
                <span class="input-group-text">@Model.WebsiteUrl</span>
                <input type="text" class="form-control @Model.HasError("RoutePath")" asp-for="Form.RoutePath" required>
            </div>
            <div class="invalid-feedback">@Model.ErrorMessageFor("RoutePath")</div>
        </div>
    </div>
    <div class="col-lg-12">
        <div class="mb-3">
            <label class="form-label raytha-required" asp-for="Form.TemplateId"></label>
            <select class="form-select @Model.HasError("TemplateId")" asp-for="Form.TemplateId"
                asp-items="Model.AvailableTemplates" required>
                <option value="">-- Select a template --</option>
            </select>
            <div class="invalid-feedback">@Model.ErrorMessageFor("TemplateId")</div>
            <div class="form-text">Choose the template that will be used to render this page.</div>
        </div>
    </div>
    
    <div class="col-lg-12 mt-4">
        <button type="submit" class="btn btn-secondary" name="Form.SaveAsDraft" value="true">Save as draft</button>
        <button type="submit" class="btn btn-success mx-2" name="Form.SaveAsDraft" value="false">Save and publish</button>
    </div>
</form>

<br />
@if (Model.Form.IsPublished)
{
    <form method="post" asp-page-handler="Unpublish" asp-route-id="@Model.Form.Id">
        <button class="btn btn-sm btn-link text-danger">
            Unpublish site page
        </button>
    </form>
}
@if (Model.Form.IsDraft)
{
    <form method="post" asp-page-handler="DiscardDraft" asp-route-id="@Model.Form.Id">
        <button class="btn btn-sm btn-link text-danger">
            Discard draft
        </button>
    </form>
}

@if ((await AuthorizationService.AuthorizeAsync(User, BuiltInSystemPermission.MANAGE_SYSTEM_SETTINGS_PERMISSION)).Succeeded)
{
    <hr class="my-4" />
    <h6 class="mb-3">Home Page</h6>
    @if (!Model.IsHomePage)
    {
        <form asp-page="@RouteNames.SitePages.Edit" asp-page-handler="SetAsHomePage" method="post"
            asp-route-id="@Model.Form.Id">
            <p class="text-muted small">Set this page as the home page for your website.</p>
            <button type="submit" class="btn btn-secondary">Set as home page</button>
        </form>
    }
    else
    {
        <p class="text-success"><i class="bi bi-check-circle me-2"></i>This site page is currently set as the home page.</p>
    }
}
