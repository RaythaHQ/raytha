@page "/raytha/themes/edit/{themeId}/widget-templates/edit/{id}"
@model Raytha.Web.Areas.Admin.Pages.Themes.WidgetTemplates.Edit

@{
    var pageTitle = $"Edit: {Model.Form.Label}";
    Layout = "SubActionLayout";
    ViewData["Title"] = pageTitle;
    ViewData["ActiveMenu"] = "Themes";
    ViewData["ActiveSubMenu"] = "Edit";
    var back = new BackLinkOptions
    {
        Page = RouteNames.Themes.WidgetTemplates.Index,
        RouteValues = new RouteValueDictionary { ["themeId"] = Model.Form.ThemeId },
        Text = "Back to widget templates",
    };
}

@(await Html.PartialAsync("_Partials/BackToList", back))

<div class="alert alert-light border mt-3 mb-4">
    <div class="row small">
        <div class="col-md-4">
            <strong>Widget Type:</strong> <code>@Model.Form.DeveloperName</code>
        </div>
        <div class="col-md-4">
            <strong>Last Modified:</strong> @Model.Form.LastModificationTime
        </div>
        <div class="col-md-4">
            <strong>Modified By:</strong> @Model.Form.LastModifierUser
        </div>
    </div>
</div>

<form asp-page="@RouteNames.Themes.WidgetTemplates.Edit" 
      asp-route-themeId="@Model.Form.ThemeId"
      asp-route-id="@Model.Form.Id" 
      method="post" 
      class="py-2" 
      novalidate>
    <input type="hidden" asp-for="Form.Id" />
    <input type="hidden" asp-for="Form.DeveloperName" />
    <input type="hidden" asp-for="Form.IsBuiltInTemplate" />

    <div class="mb-3">
        <label class="form-label raytha-required" asp-for="Form.Label"></label>
        <input type="text" class="form-control @Model.HasError("Label")" asp-for="Form.Label" required>
        <div class="invalid-feedback">@Model.ErrorMessageFor("Label")</div>
    </div>

    <div class="mb-3">
        <label class="form-label raytha-required" asp-for="Form.Content"></label>
        <div class="form-text mb-2">
            This Liquid template defines how the <strong>@Model.Form.Label</strong> widget is rendered. 
            Widget settings are available via <code>widget.settings</code>.
        </div>
        <div id="editorContainer" style="height:600px;overflow: auto;"></div>
        <input type="hidden" asp-for="Form.Content" id="Form_Content">
        <div class="invalid-feedback">@Model.ErrorMessageFor("Content")</div>
    </div>

    <input type="hidden" asp-for="Form.Id">
    <input type="hidden" asp-for="Form.IsBuiltInTemplate">
    <button type="submit" class="btn btn-success mt-4">Publish changes</button>
</form>

<div class="card border-0 shadow mb-4 mt-4">
    <div class="card-header">
        <h6 class="mb-0">Widget Settings Reference</h6>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Access widget settings in your template using the following Liquid syntax:
        </p>
        <pre class="bg-light p-3 rounded small"><code>&#123;% comment %&#125;
  Access the widget instance ID:
&#123;% endcomment %&#125;
&#123;&#123; widget.id &#125;&#125;

&#123;% comment %&#125;
  Access widget settings (defined per widget type):
&#123;% endcomment %&#125;
&#123;&#123; widget.settings.headline &#125;&#125;
&#123;&#123; widget.settings.content &#125;&#125;
&#123;&#123; widget.settings.backgroundColor &#125;&#125;

&#123;% comment %&#125;
  Loop through array settings (e.g., cards, items):
&#123;% endcomment %&#125;
&#123;% for item in widget.settings.items %&#125;
  &#123;&#123; item.title &#125;&#125;
&#123;% endfor %&#125;</code></pre>
    </div>
</div>

@section Scripts {
<script type="module">
    import { 
        EditorState,
        EditorView,
        basicSetup,
        html,
        javascript,
        css,
        indentWithTab,
        keymap
    } from '/raytha_admin/lib/codemirror/codemirror-bundle.js';

    // --- CodeMirror editor ---
    const startState = EditorState.create({
        doc: @Html.Raw(Json.Serialize(Model.Form.Content ?? string.Empty)),
        extensions: [
            basicSetup,
            html({
                matchClosingTags: true,
                autoCloseTags: true,
                codeLanguages: [javascript(), css()]
            }),
            keymap.of([indentWithTab]),
            EditorView.updateListener.of((update) => {
                if (update.docChanged) {
                    const el = document.getElementById('Form_Content');
                    if (el) el.value = view.state.doc.toString();
                }
            })
        ],
    });

    const view = new EditorView({
        state: startState,
        parent: document.getElementById('editorContainer')
    });
</script>
}
